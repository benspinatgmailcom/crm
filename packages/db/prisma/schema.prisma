// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id           String    @id @default(cuid())
  name         String
  industry     String?
  website      String?
  sourceLeadId String?  @unique
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  sourceLead   Lead?     @relation("AccountSourceLead", fields: [sourceLeadId], references: [id], onDelete: SetNull)
  contacts     Contact[]
  opportunities Opportunity[]

  @@index([sourceLeadId])
}

model Contact {
  id           String   @id @default(cuid())
  accountId    String
  firstName    String
  lastName     String
  email        String
  phone        String?
  sourceLeadId String?  @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  account    Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  sourceLead Lead?   @relation("ContactSourceLead", fields: [sourceLeadId], references: [id], onDelete: SetNull)

  @@index([sourceLeadId])
}

model Lead {
  id                   String    @id @default(cuid())
  name                 String
  email                String
  company              String?
  status               String?   @default("new")
  source               String?
  convertedAccountId   String?
  convertedContactId   String?
  convertedOpportunityId String?
  convertedAt          DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  convertedAccount     Account?     @relation("AccountSourceLead")
  convertedContact     Contact?     @relation("ContactSourceLead")
  convertedOpportunity Opportunity? @relation("OpportunitySourceLead")
}

model Opportunity {
  id            String    @id @default(cuid())
  accountId     String
  name          String
  amount        Decimal?  @db.Decimal(14, 2)
  stage         String?   @default("prospecting")
  probability   Int?
  closeDate     DateTime?
  sourceLeadId  String?  @unique
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  account    Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  sourceLead Lead?   @relation("OpportunitySourceLead", fields: [sourceLeadId], references: [id], onDelete: SetNull)

  @@index([sourceLeadId])
  @@index([stage, updatedAt, closeDate])
}

model Activity {
  id         String    @id @default(cuid())
  entityType String
  entityId   String
  type       String    // note, call, meeting, email, task, ai_summary
  payload    Json?     @default("{}")
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  @@index([entityType, entityId])
  @@index([entityType, entityId, createdAt])
}

model User {
  id                 String    @id @default(cuid())
  email              String    @unique
  passwordHash       String
  role               String    @default("USER") // ADMIN, USER, VIEWER
  isActive           Boolean   @default(true)
  mustChangePassword Boolean   @default(false)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  refreshTokens       RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  attachments         Attachment[]
}

model Attachment {
  id                String    @id @default(uuid())
  entityType        String
  entityId          String
  fileName          String    // original name
  mimeType          String
  size              Int
  storageKey        String
  storageDriver     String    @default("local") // "local" | "s3"
  bucket            String?   // null = local; S3 bucket name when driver=s3
  uploadedByUserId  String
  extractedText     String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  uploadedByUser User @relation(fields: [uploadedByUserId], references: [id], onDelete: Restrict)

  @@index([entityType, entityId, createdAt])
  @@index([uploadedByUserId])
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String
  tokenHash String
  revokedAt DateTime?
  expiresAt DateTime
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PasswordResetToken {
  id         String    @id @default(cuid())
  userId     String
  tokenHash  String    @unique
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}
